<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta name="keywords" content="Java NIO, Network Application, Framework, OSGi, JRuyi">
		<meta name="viewport" content="width=device-width; initial-scale=1.0, maximum-scale=1">
		<link href="http://gmpg.org/xfn/11" rel="profile">

		<title>
			Getting Started &middot; JRuyi, as you wish
		</title>

		<!-- CSS -->
		<link rel="stylesheet" href="/public/css/hyde.css">
		<link rel="stylesheet" href="/public/css/jruyi.css">
		<link rel="stylesheet" href="/public/css/syntax.css">
		<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

		<!-- RSS -->
		<link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

		<script>
			(function(i, s, o, g, r, a, m) {
				i['GoogleAnalyticsObject'] = r;
				i[r] = i[r] || function() {
					(i[r].q = i[r].q || []).push(arguments)
				}, i[r].l = 1 * new Date();
				a = s.createElement(o), m = s.getElementsByTagName(o)[0];
				a.async = 1;
				a.src = g;
				m.parentNode.insertBefore(a, m)
			})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
			ga('create', 'UA-46193512-1', 'jruyi.org');
			ga('send', 'pageview');
		</script>
	</head>
	<body>
		<header class="masthead">
			<div class="masthead-inner">
				<h1>JRuyi</h1>
				<p class="lead">A Java framework for easily developing network applications as you wish.</p>

				<div class="colophon">
					<ul class="colophon-links">
						<li><a href="/">Home</a></li>
						<li><a href="/download">Download</a></li>
						<li><a href="/gettingstarted">Getting Started</a></li>
						<li><a href="/userguide">User Guide</a></li>
						<li><a href="/javadoc">Javadoc</a></li>
						<li><a href="/news">News</a></li>
						<li><a href="/license">License</a></li>
						<li><a href="https://github.com/jruyi/jruyi">View On GitHub</a></li>
					</ul>
					<p>Copyright &copy; 2013-2014 JRuyi.org.<br/>All rights reserved.</p>
				</div>
			</div>
		</header>
		<div class="content container">
			<div class="posts">
	<div class="post">
		<h3 class="section">Getting Started</h3>
		<hr/>
		<h1>Writing a Daytime Server</h1>

<p>In this example, we are going to build a <a href="http://tools.ietf.org/html/rfc867">TCP based daytime service</a> which need send back the current date and time when a connection is established.</p>

<p>Through this example, you will learn how to create a Session Service of <em>tcpserver</em> programmatically and not touch Messaging Engine. That is to say, no need to create a Session Service Endpoint.</p>

<p>The full source code of this example can be found in <a href="https://github.com/jruyi/jruyi-eg">jruyi-eg</a>.</p>

<h3>1. Write a DaytimeServer Component</h3>

<ul>
<li><p>Write an immediate component <em>jruyi.eg.daytime</em> which will be activated/deactivated when bundle starts/stops. The implementation class is <em>org.jruyi.eg.daytime.DaytimeServer</em> which extends <a href="http://www.jruyi.org/javadoc/1.2.0/org/jruyi/io/SessionListener.html">SessionListener</a>.</p></li>
<li><p>Create an instance of <a href="http://www.jruyi.org/javadoc/1.2.0/org/jruyi/io/ISessionService.html">ISessionService</a> of tcpserver, and start it when component is being activated; stop it when component is being deactivated.</p></li>
<li><p>Construct the daytime message and send it to the client when a connection is established.</p></li>
<li><p>Close the connection through which a daytime message is sent.</p></li>
</ul>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">jruyi</span><span class="o">.</span><span class="na">eg</span><span class="o">.</span><span class="na">daytime</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.felix.scr.annotations.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.scr.annotations.Properties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.scr.annotations.Property</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.felix.scr.annotations.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.Codec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.IBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.ISession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.ISessionService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.IoConstants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jruyi.io.SessionListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.ComponentConstants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.ComponentFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.osgi.service.component.ComponentInstance</span><span class="o">;</span>

<span class="nd">@Component</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jruyi.eg.daytime&quot;</span><span class="o">,</span>
    <span class="n">immediate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="c1">// immediate component</span>
    <span class="n">createPid</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="c1">// Don&#39;t create property service.pid</span>
    <span class="n">metatype</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// create metatype descriptor file</span>
<span class="o">)</span>
<span class="nd">@Properties</span><span class="o">({</span>
    <span class="c1">// This IO service is identified with jruyi.eg.daytime.</span>
    <span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">IoConstants</span><span class="o">.</span><span class="na">SERVICE_ID</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;jruyi.eg.daytime&quot;</span><span class="o">,</span>
        <span class="cm">/* non-configurable property */</span> <span class="n">propertyPrivate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">),</span>
    <span class="c1">// Configurable property for the address to be bound to</span>
    <span class="c1">// Bound to any local address by default</span>
    <span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bindAddr&quot;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;0.0.0.0&quot;</span><span class="o">),</span>
    <span class="c1">// Configurable property for the listening port</span>
    <span class="c1">// Listen on port 9013 by default</span>
    <span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;port&quot;</span><span class="o">,</span> <span class="n">intValue</span> <span class="o">=</span> <span class="mi">9013</span><span class="o">),</span>
    <span class="c1">// Configurable property for enabling/disabling Nagle&#39;s algorithm</span>
    <span class="c1">// Disable Nagle&#39;s algorithm by default</span>
    <span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tcpNoDelay&quot;</span><span class="o">,</span> <span class="n">boolValue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DaytimeServer</span> <span class="kd">extends</span> <span class="n">SessionListener</span> <span class="o">{</span>

    <span class="c1">// Specify the dependency service</span>
    <span class="nd">@Reference</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tcpServerFactory&quot;</span><span class="o">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s">&quot;(&quot;</span>
            <span class="o">+</span> <span class="n">ComponentConstants</span><span class="o">.</span><span class="na">COMPONENT_NAME</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span>
            <span class="o">+</span> <span class="n">IoConstants</span><span class="o">.</span><span class="na">CN_TCPSERVER_FACTORY</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">ComponentFactory</span> <span class="n">m_tcpServerFactory</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">ComponentInstance</span> <span class="n">m_tcpServer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ISessionService</span> <span class="n">m_ss</span><span class="o">;</span>

    <span class="c1">// This method is called when a connection is established</span>
    <span class="c1">// and ready to send/recv data.</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSessionOpened</span><span class="o">(</span><span class="n">ISession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Current date and time</span>
        <span class="n">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span>
                <span class="s">&quot;EEEE, MMMM d, yyyy HH:mm:ss-zzz&quot;</span><span class="o">,</span> <span class="n">Locale</span><span class="o">.</span><span class="na">ENGLISH</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">daytime</span> <span class="o">=</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>

        <span class="c1">// Allocate the buffer and construct the message</span>
        <span class="n">IBuffer</span> <span class="n">out</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createBuffer</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">daytime</span><span class="o">,</span> <span class="n">Codec</span><span class="o">.</span><span class="na">us_ascii</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;\r\n&quot;</span><span class="o">,</span> <span class="n">Codec</span><span class="o">.</span><span class="na">us_ascii</span><span class="o">());</span>

        <span class="c1">// Send out the message</span>
        <span class="n">m_ss</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// This method is called after the given msg is sent.</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessageSent</span><span class="o">(</span><span class="n">ISession</span> <span class="n">session</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Close the connection</span>
        <span class="n">m_ss</span><span class="o">.</span><span class="na">closeSession</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">bindTcpServerFactory</span><span class="o">(</span><span class="n">ComponentFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">m_tcpServerFactory</span> <span class="o">=</span> <span class="n">factory</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">unbindTcpServerFactory</span><span class="o">(</span><span class="n">ComponentFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">m_tcpServerFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// This method is called when this component is being activated.</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">activate</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">properties</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Create the Session Service of tcpserver</span>
        <span class="n">ComponentInstance</span> <span class="n">tcpServer</span> <span class="o">=</span> <span class="n">m_tcpServerFactory</span>
                <span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;(</span><span class="n">properties</span><span class="o">));</span>
        <span class="n">ISessionService</span> <span class="n">ss</span> <span class="o">=</span> <span class="o">(</span><span class="n">ISessionService</span><span class="o">)</span> <span class="n">tcpServer</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>

        <span class="c1">// Set SessionListener</span>
        <span class="n">ss</span><span class="o">.</span><span class="na">setSessionListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="c1">// Start the Session Service</span>
        <span class="n">ss</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">m_tcpServer</span> <span class="o">=</span> <span class="n">tcpServer</span><span class="o">;</span>
        <span class="n">m_ss</span> <span class="o">=</span> <span class="n">ss</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// This method is called when this component is being deactivated.</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Stop the Session Service</span>
        <span class="n">m_tcpServer</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
        <span class="n">m_tcpServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">m_ss</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h3>2. Start JRuyi</h3>

<p>If JRuyi has not been started yet, please go to $JRUYI_HOME and start JRuyi as follows.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi
</code></pre></div>
<h3>3. Build This Example</h3>

<p>We will use /home/jruyi/jruyi-eg as the path of the local copy of <a href="https://github.com/jruyi/jruyi-eg">jruyi-eg</a> repository.</p>

<p>To build this example, go to /home/jruyi/jruyi-eg/daytime and run the following command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">mvn clean install
</code></pre></div>
<p>You will get the bundle <em>org.jruyi.eg.daytime-1.0.0-SNAPSHOT.jar</em> under /home/jruyi/jruyi-eg/daytime/target.</p>

<h3>4. Deploy</h3>

<p>Go to $JRUYI_HOME, and run the following command to deploy the daytime bundle.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi-cli bundle:start file:/home/jruyi/jruyi-eg/daytime/target/org.jruyi.eg.daytime-1.0.0-SNAPSHOT.jar
</code></pre></div>
<p>Or if you copied the bundle to $JRUYI_HOME/bundles, then you can run the following command to deploy.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi-cli bundle:start ${jruyi.bundle.base.url}org.jruyi.eg.daytime-1.0.0-SNAPSHOT.jar
</code></pre></div>
<h3>5. Test</h3>

<p>You can use telnet to test the daytime server you just built.
For example, you can run the following command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">telnet localhost 9013
</code></pre></div>
<p>You will get the current date and time in the following format.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Weekday, Month Day, Year Time-Zone
</code></pre></div>
<p>And the connection will be closed by the server right after you get the message.</p>

<h3>6. Change the Listening Port Dynamically</h3>

<p>You can change the listening port dynamically without shutting down JRuyi. In fact, you can change any configurable property dynamically.</p>

<p>First, run the following command to see if configuration <em>jruyi.eg.daytime</em> exists.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi-cli conf:list | grep jruyi.eg.daytime
</code></pre></div>
<p>If nothing is printed, it means that configuration <em>jruyi.eg.daytime</em> does not exist. Otherwise, configuration <em>jruyi.eg.daytime</em> exists.</p>

<p>Second, if configuration <em>jruyi.eg.daytime</em> does not exist, please change the listening port by creating the configuration <em>jruyi.eg.daytime</em> as follows.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi-cli conf:create jruyi.eg.daytime port=10013
</code></pre></div>
<p>Otherwise, please change the listening port by updating the configuration <em>jruyi.eg.daytime</em> as follows.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bin/ruyi-cli conf:update jruyi.eg.daytime port=10013
</code></pre></div>
<p>Third, you can see that the port is changed by testing with telnet.</p>

<p>The connection will be refused if you run the following command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">telnet localhost 9013
</code></pre></div>
<p>While you will get the current date and time successfully by running the following command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">telnet localhost 10013
</code></pre></div>
	</div>
</div>


		</div>
	</body>
</html>
